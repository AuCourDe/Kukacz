<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <title>Gacek ðŸ¦‡ â€“ panel</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #050c16;
        --card: rgba(20, 32, 56, 0.75);
        --accent: #18b47c;
        --warning: #f5a524;
        --error: #ff5f5f;
        --text: #f1f5f9;
        --muted: #94a3b8;
      }
      body {
        font-family: "Inter", Arial, sans-serif;
        background: radial-gradient(circle at top, #152339, #050c16 60%);
        color: var(--text);
        margin: 0;
        min-height: 100vh;
      }
      header {
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }
      header h1 {
        margin: 0;
        font-size: 1.4rem;
        letter-spacing: 0.5px;
        flex: 1;
        text-align: center;
      }
      header a {
        color: #fff;
        text-decoration: none;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 0.35rem 0.8rem;
        border-radius: 999px;
      }
      main {
        padding: 0 2rem 2.5rem;
        display: grid;
        gap: 1.5rem;
        max-width: 1200px;
        margin: 0 auto;
      }
      .card {
        background: var(--card);
        border-radius: 18px;
        padding: 1.75rem;
        box-shadow: 0 25px 45px rgba(5, 12, 22, 0.55);
        backdrop-filter: blur(10px);
      }
      h2 {
        margin-top: 0;
      }
      .flash {
        padding: 0.85rem 1rem;
        border-radius: 12px;
        margin-bottom: 1rem;
      }
      .flash.success {
        background: rgba(24, 180, 124, 0.15);
        border: 1px solid rgba(24, 180, 124, 0.45);
      }
      .flash.warning {
        background: rgba(245, 165, 36, 0.15);
        border: 1px solid rgba(245, 165, 36, 0.45);
      }
      .flash.error {
        background: rgba(255, 95, 95, 0.18);
        border: 1px solid rgba(255, 95, 95, 0.45);
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      input[type="file"] {
        padding: 1.25rem;
        border: 1px dashed rgba(255, 255, 255, 0.25);
        border-radius: 16px;
        color: var(--muted);
        background: rgba(255, 255, 255, 0.02);
      }
      button {
        background: var(--accent);
        color: #04101a;
        border: none;
        border-radius: 999px;
        font-size: 1.05rem;
        padding: 0.95rem;
        font-weight: 600;
        cursor: pointer;
      }
      button:hover {
        opacity: 0.92;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 0.9rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      th {
        font-size: 0.95rem;
        color: var(--muted);
        font-weight: 500;
        letter-spacing: 0.4px;
      }
      td small {
        color: var(--muted);
      }
      .status {
        border-radius: 999px;
        padding: 0.25rem 0.8rem;
        font-size: 0.85rem;
        font-weight: 600;
      }
      .status.queued {
        background: rgba(138, 180, 248, 0.15);
        color: #8ab4f8;
      }
      .status.processing {
        background: rgba(245, 165, 36, 0.15);
        color: #f5a524;
      }
      .status.completed {
        background: rgba(24, 180, 124, 0.15);
        color: #37f1ab;
      }
      .status.failed {
        background: rgba(255, 95, 95, 0.2);
        color: #ff8f8f;
      }
      .queue-empty {
        text-align: center;
        color: var(--muted);
        padding: 1.5rem 0;
      }
      .downloads a {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.3rem 0.7rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        text-decoration: none;
        font-size: 0.85rem;
        margin-right: 0.4rem;
      }
      footer {
        text-align: center;
        padding: 1rem;
        color: var(--muted);
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Gacek ðŸ¦‡</h1>
      <a href="{{ url_for('logout') }}">Wyloguj</a>
    </header>
    <main>
      <section class="card">
        <h2>Dodaj pliki audio</h2>
        <p>ObsÅ‚ugiwane formaty: {{ allowed_extensions|join(', ') }}</p>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data">
          <input type="file" name="files" accept="{{ accept_attribute }}" multiple required />
          <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
            <input type="checkbox" name="enable_preprocessing" value="1" checked style="width: auto;" />
            <span>Audio Preprocessor (odszumianie, normalizacja, poprawa jakoÅ›ci)</span>
          </label>
          <button type="submit">Zapisz i przetwÃ³rz</button>
        </form>
      </section>

      <section class="card">
        <h2>Kolejka przetwarzania</h2>
        <div class="queue-wrapper">
          <table>
            <thead>
              <tr>
                <th>Plik</th>
                <th>Rozmiar</th>
                <th>Status</th>
                <th>Wyniki</th>
              </tr>
            </thead>
            <tbody id="queue-body">
              {% if not queue_items %}
                <tr class="queue-empty">
                  <td colspan="4">Brak zadaÅ„ w kolejce.</td>
                </tr>
              {% else %}
                {% for item in queue_items %}
                  <tr data-id="{{ item.id }}">
                    <td>
                      {{ item.filename }}
                      <br />
                      <small>Dodano: {{ item.created_at }}</small>
                    </td>
                    <td>{{ item.size_mb }} MB</td>
                    <td>
                      <span class="status {{ item.status }}">
                        {{ status_labels[item.status] }}
                      </span>
                      {% if item.status == "processing" %}
                        <br /><small id="countdown-{{ item.id }}">Obliczanie...</small>
                      {% elif item.status == "completed" and item.processing_time %}
                        <br /><small>Czas przetwarzania: {{ item.processing_time }}</small>
                      {% elif item.error %}
                        <br /><small>{{ item.error }}</small>
                      {% endif %}
                    </td>
                    <td class="downloads">
                      {% if item.status == "completed" %}
                        <a href="{{ url_for('download_result', queue_id=item.id, file_type='transcription') }}">Transkrypcja</a>
                        <a href="{{ url_for('download_result', queue_id=item.id, file_type='analysis') }}">Analiza</a>
                      {% else %}
                        <small>â€“</small>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
    <footer>
      DostÄ™p tylko dla administratora â€“ wszystkie dziaÅ‚ania sÄ… logowane.
    </footer>
    <script>
      const statusLabels = {{ status_labels|tojson }};
      const queueBody = document.getElementById("queue-body");

      async function refreshQueue() {
        try {
          const response = await fetch("{{ url_for('queue_json') }}", { cache: "no-store" });
          if (!response.ok) return;
          const data = await response.json();
          renderQueue(data.items || []);
        } catch (err) {
          console.error("Nie udaÅ‚o siÄ™ pobraÄ‡ kolejki", err);
        }
      }

      // Mapa do przechowywania czasu rozpoczÄ™cia przetwarzania dla odliczania
      const processingStarts = new Map();
      const countdownIntervals = new Map();

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        if (mins > 0) {
          return `${mins}m ${secs}s`;
        }
        return `${secs}s`;
      }

      function updateCountdown(itemId, estimatedMinutes, startedAt) {
        if (!startedAt) return;

        const startTime = new Date(startedAt).getTime();
        const estimatedMs = estimatedMinutes * 60 * 1000;
        const endTime = startTime + estimatedMs;

        function update() {
          const now = Date.now();
          const elapsed = Math.floor((now - startTime) / 1000);
          const remaining = Math.max(0, Math.floor((endTime - now) / 1000));

          const countdownEl = document.getElementById(`countdown-${itemId}`);
          if (countdownEl) {
            if (remaining > 0) {
              countdownEl.textContent = `PozostaÅ‚o: ${formatTime(remaining)}`;
            } else {
              countdownEl.textContent = `Przetwarzanie... (${formatTime(elapsed)})`;
            }
          }
        }

        // Aktualizuj od razu
        update();

        // Ustaw interwaÅ‚ aktualizacji co sekundÄ™
        if (countdownIntervals.has(itemId)) {
          clearInterval(countdownIntervals.get(itemId));
        }
        const interval = setInterval(update, 1000);
        countdownIntervals.set(itemId, interval);
      }

      function stopCountdown(itemId) {
        if (countdownIntervals.has(itemId)) {
          clearInterval(countdownIntervals.get(itemId));
          countdownIntervals.delete(itemId);
        }
        processingStarts.delete(itemId);
      }

      function renderQueue(items) {
        if (!items.length) {
          queueBody.innerHTML = '<tr class="queue-empty"><td colspan="4">Brak zadaÅ„ w kolejce.</td></tr>';
          return;
        }
        queueBody.innerHTML = items
          .map((item) => {
            const downloads =
              item.status === "completed"
                ? `<a href="/download/${item.id}/transcription">Transkrypcja</a>
                   <a href="/download/${item.id}/analysis">Analiza</a>`
                : "<small>â€“</small>";
            
            let statusHtml = `<span class="status ${item.status}">${statusLabels[item.status] || item.status}</span>`;
            
            if (item.status === "processing" && item.started_at) {
              // Uruchom odliczanie dla przetwarzajÄ…cych zadaÅ„
              if (!processingStarts.has(item.id)) {
                processingStarts.set(item.id, { start: item.started_at, estimated: item.estimated_minutes });
                updateCountdown(item.id, item.estimated_minutes, item.started_at);
              }
              statusHtml += `<br/><small id="countdown-${item.id}">Obliczanie...</small>`;
            } else if (item.status === "completed" && item.processing_time) {
              stopCountdown(item.id);
              statusHtml += `<br/><small>Czas przetwarzania: ${item.processing_time}</small>`;
            } else if (item.status === "failed") {
              stopCountdown(item.id);
              if (item.error) {
                statusHtml += `<br/><small>${item.error}</small>`;
              }
            } else {
              stopCountdown(item.id);
            }

            return `<tr data-id="${item.id}">
              <td>${item.filename}<br/><small>Dodano: ${item.created_at}</small></td>
              <td>${item.size_mb} MB</td>
              <td>${statusHtml}</td>
              <td class="downloads">${downloads}</td>
            </tr>`;
          })
          .join("");
      }

      setInterval(refreshQueue, 5000);
    </script>
  </body>
</html>


